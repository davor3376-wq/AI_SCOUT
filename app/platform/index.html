<!DOCTYPE html>
<html>
<head>
    <title>Command Center V2</title>
    <!-- Leaflet & Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 300px; background: #f4f4f4; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto;}
        #map { flex-grow: 1; height: 100%; }
        .control-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="date"] { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        button:hover { background: #0056b3; }
        #time-slider-container {
            position: absolute; bottom: 30px; left: 320px; right: 20px;
            background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 5px; z-index: 1000;
            display: none; /* Hidden until results */
        }
        #time-slider { width: 100%; }
        #mission-status { margin-top: 20px; padding: 10px; border: 1px solid #ddd; background: #fff; min-height: 50px; }
        .preview-img { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; }
        #layer-control { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }

        /* History Styles */
        #history-list { list-style: none; padding: 0; margin-top: 10px; }
        .history-item {
            background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; cursor: pointer;
            border-radius: 4px; transition: background 0.2s;
        }
        .history-item:hover { background: #e9ecef; }
        .history-item strong { display: block; color: #333; }
        .history-item span { font-size: 0.8em; color: #666; }
        .history-item.active { border-left: 5px solid #007bff; background: #eef; }
        .status-badge { display: inline-block; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; color: white; margin-top: 5px;}
        .status-PENDING { background: #ffc107; color: #000; }
        .status-RUNNING { background: #17a2b8; }
        .status-COMPLETED { background: #28a745; }
        .status-FAILED { background: #dc3545; }

        #pdf-btn { background: #28a745; display: none; }
        #pdf-btn:hover { background: #218838; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Mission Control</h2>

    <div class="control-group">
        <label>Date Range</label>
        <input type="date" id="start-date">
        <input type="date" id="end-date">
    </div>

    <div class="control-group">
        <label>Sensor</label>
        <div>
            <input type="radio" id="sensor-optical" name="sensor" value="OPTICAL" checked>
            <label for="sensor-optical" style="display:inline; font-weight:normal">Optical (Sentinel-2)</label>
        </div>
        <div>
            <input type="radio" id="sensor-radar" name="sensor" value="RADAR">
            <label for="sensor-radar" style="display:inline; font-weight:normal">Radar (Sentinel-1)</label>
        </div>
    </div>

    <button id="launch-btn">Launch Mission</button>

    <div id="mission-status">
        <strong>Status:</strong> <span id="status-text">Ready</span>
        <br>
        <div id="status-details"></div>
        <button id="pdf-btn">Download PDF Report</button>
    </div>

    <div id="layer-control">
        <label><input type="checkbox" id="toggle-processed" checked> Show Processed Layer</label>
    </div>

    <hr>
    <h3>Mission History</h3>
    <ul id="history-list"></ul>
</div>

<div id="map"></div>

<div id="time-slider-container">
    <label for="time-slider">Time Scrubber</label>
    <input type="range" id="time-slider" min="0" max="0" step="1" value="0">
    <span id="current-date"></span>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
    // Initialize Map
    var map = L.map('map').setView([48.2, 16.35], 10); // Vienna default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Add Processed Tile Layer
    var tileUrlTemplate = '/tiles/{z}/{x}/{y}';
    var processedLayer = L.tileLayer(tileUrlTemplate, {
        tms: false,
        opacity: 0.7,
        maxZoom: 18,
        attribution: 'Project Gaia'
    }).addTo(map);

    document.getElementById('toggle-processed').addEventListener('change', function(e) {
        if (e.target.checked) {
            processedLayer.addTo(map);
        } else {
            map.removeLayer(processedLayer);
        }
    });

    // Initialize Draw Control
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    var drawControl = new L.Control.Draw({
        draw: {
            polygon: true,
            marker: true,
            polyline: false,
            rectangle: true,
            circle: false,
            circlemarker: false
        },
        edit: {
            featureGroup: drawnItems
        }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        var layer = e.layer;
        drawnItems.addLayer(layer);
    });

    // Default Dates
    var today = new Date();
    var lastMonth = new Date();
    lastMonth.setDate(today.getDate() - 30);
    document.getElementById('end-date').valueAsDate = today;
    document.getElementById('start-date').valueAsDate = lastMonth;

    var currentJobId = null;

    // Load History
    async function loadHistory() {
        try {
            const res = await fetch('/jobs');
            const jobs = await res.json();
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'history-item';
                if (job.id === currentJobId) li.classList.add('active');

                li.innerHTML = `
                    <strong>${job.id}</strong>
                    <span>${job.created_at.split('T')[0]} - ${job.sensor}</span><br>
                    <span class="status-badge status-${job.status}">${job.status}</span>
                `;
                li.onclick = () => selectJob(job.id);
                list.appendChild(li);
            });
        } catch (e) {
            console.error("Failed to load history", e);
        }
    }

    async function selectJob(jobId) {
        currentJobId = jobId;
        loadHistory(); // Update active class

        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');
        const pdfBtn = document.getElementById('pdf-btn');

        statusText.innerText = "Loading Job...";
        statusDetails.innerHTML = "";
        pdfBtn.style.display = "none";

        try {
            const res = await fetch(`/jobs/${jobId}`);
            if (!res.ok) throw new Error("Job not found");
            const job = await res.json();

            statusText.innerText = job.status;

            // Show details
            if (job.tag) statusDetails.innerHTML += `Tag: <b>${job.tag}</b><br>`;
            if (job.error) statusDetails.innerHTML += `<span style="color:red">Error: ${job.error}</span><br>`;

            // Zoom to AOI
            if (job.bbox) {
                 // bbox: [minx, miny, maxx, maxy]
                 // fitBounds: [[miny, minx], [maxy, maxx]]
                 map.fitBounds([[job.bbox[1], job.bbox[0]], [job.bbox[3], job.bbox[2]]]);
            }

            // Update Tile Layer
            processedLayer.setUrl(`${tileUrlTemplate}?job_id=${jobId}`);

            // PDF Button
            if (job.status === "COMPLETED") {
                pdfBtn.style.display = "block";
                pdfBtn.onclick = () => {
                    window.open(`/jobs/${jobId}/pdf`, '_blank');
                };
            }

            // Preview (Search Results) on Map (Optional, maybe specific tile is better)
            // If we have processed result, tile layer handles it.
            // If pending, maybe show preview overlay?
            if (job.status !== "COMPLETED" && job.preview_url) {
                 // Show preview overlay if available
                 if (currentOverlay) map.removeLayer(currentOverlay);
                 // ... logic for preview overlay
            }

            // Setup slider if we have search results stored in job
            if (job.search_results && job.search_results.results) {
                 setupTimeSlider(job.search_results.results);
            }

        } catch (e) {
            statusText.innerText = "Error loading job";
            console.error(e);
        }
    }

    // Launch Mission Logic
    document.getElementById('launch-btn').addEventListener('click', async () => {
        var startDate = document.getElementById('start-date').value;
        var endDate = document.getElementById('end-date').value;
        var sensor = document.querySelector('input[name="sensor"]:checked').value;

        var layers = drawnItems.getLayers();
        if (layers.length === 0) {
            alert("Please draw an Area of Interest (AOI) on the map.");
            return;
        }
        var geojson = layers[0].toGeoJSON();

        var statusText = document.getElementById('status-text');
        var statusDetails = document.getElementById('status-details');
        statusText.innerText = "Launching...";
        statusDetails.innerHTML = "";

        try {
            const response = await fetch('/launch_custom_mission', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    geometry: geojson.geometry,
                    start_date: startDate,
                    end_date: endDate,
                    sensor: sensor
                })
            });

            if (!response.ok) throw new Error("Mission Failed");

            const result = await response.json();
            statusText.innerText = "Job Started";
            statusDetails.innerHTML = `Job ID: ${result.job_id}<br>`;

            if (result.tag) statusDetails.innerHTML += `Tag: <b>${result.tag}</b><br>`;
            if (result.preview_url) {
                 statusDetails.innerHTML += `<a href="${result.preview_url}" target="_blank">View Preview</a>`;
            }

            // Reload history and select new job
            await loadHistory();
            selectJob(result.job_id);

        } catch (error) {
            statusText.innerText = "Error";
            statusDetails.innerHTML = error.message;
        }
    });

    var currentOverlay = null;

    function setupTimeSlider(results) {
        var slider = document.getElementById('time-slider');
        var container = document.getElementById('time-slider-container');
        var dateLabel = document.getElementById('current-date');

        if (!results || results.length === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        slider.max = results.length - 1;
        slider.value = 0;

        var updateMap = (index) => {
             var item = results[index];
             dateLabel.innerText = item.date;

             if (currentOverlay) {
                 map.removeLayer(currentOverlay);
             }

             if (item.bbox && item.preview_url) {
                 var bounds = [[item.bbox[1], item.bbox[0]], [item.bbox[3], item.bbox[2]]];
                 currentOverlay = L.imageOverlay(item.preview_url, bounds).addTo(map);
             }
        };

        slider.oninput = function() {
            updateMap(this.value);
        }
        // Don't auto-show first one if we want to show processed tiles instead
        // But useful for context.
        updateMap(0);
    }

    // Initial Load
    loadHistory();

</script>
</body>
</html>
